[Back to the Ling/CSRFTools api](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools.md)



The CSRFProtector class
================
2019-04-11 --> 2021-03-05






Introduction
============

The CSRFProtector class.

This class can be used as a singleton, or as a regular class (it's an hybrid).


How this class works
================
Before using this class, you should have a basic understanding of how it works.

In this class, a token is composed of two things:

- a name
- a value

The value of the token is always generated by this class, it's a random value, like 98f0z0fzegijzgozhu for instance.
The name of the token is chosen by you.

With this class, you can generate tokens, using the createToken method.
This method will not only return the value of the token, but also store it in the php session.

You can then check whether a given token has the value you think it has (using the isValid method): this is the
heart of the CSRF validation; if you can predict the value of a token, then you must be the one who created it (at least
that's the logic behind it).

Now what's peculiar to this class is that the tokens are stored in slots.
More precisely, there are two possible slots:
- new
- old

By default, the createToken method stores a token in the new slot.
But then if you call the createToken method again with the same token name, the "new" slot will be replaced by
a new token value (random string generated by this class), but the old token value is transferred to the
"old" slot rather than being completely replaced.

Why is that so you might ask?

This has to do with how forms are implemented in php applications.
A form is first displayed, then the user posts the form.
In terms of page invocation, this means that the form page is usually invoked at least twice:
- the first time to display the form to the user
- the second time to test the posted data against some validation mechanism


And so the first time we create the token and it goes to the new slot.
And the second time, we want to validate the token, but a new token has been regenerated (since we posted the form
and the page has been refreshed), and so we want to validate the token against the old slot.


Now  which slot you want to validate against really depends on your application and your concrete case.

For instance for csrf protected backend services accessed via ajax, we generally want to use the new slot all the time.
When the user calls the page, we generate the token, but when he calls the service via ajax, the page generating the token
has not been recalled, and so the token is still in the "new slot".

That's why the isValid method let you choose which slot you want to validate against.




The delete method
-------------

I would recommend using it wherever you can, because it completely prevents an attacker from guessing the token.
However in some cases, the token cannot be deleted otherwise your own users cannot use them.
So, you have to assess the situation for yourself, and decide whether you should use the delete method.



Class synopsis
==============


class <span class="pl-k">CSRFProtector</span>  {

- Properties
    - private static [Ling\CSRFTools\CSRFProtector](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector.md) [$inst](#property-inst) ;
    - protected string [$sessionName](#property-sessionName) ;
    - protected bool [$usePage](#property-usePage) ;

- Methods
    - public static [inst](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/inst.md)() : [CSRFProtector](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector.md)
    - public [__construct](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/__construct.md)() : void
    - public [setUsePage](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/setUsePage.md)(bool $usePage) : void
    - public [createToken](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/createToken.md)(string $tokenName) : string
    - public [hasToken](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/hasToken.md)(string $tokenName) : bool
    - public [isValid](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/isValid.md)(string $tokenName, string $tokenValue, ?bool $useNewSlot = false) : bool
    - public [deleteToken](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/deleteToken.md)(string $tokenName) : void
    - public [deletePageUnusedTokens](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/deletePageUnusedTokens.md)() : void
    - public [dump](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/dump.md)() : string
    - public [cleanSession](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/cleanSession.md)() : void
    - protected [startSession](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/startSession.md)() : void
    - protected [addTokenForPage](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/addTokenForPage.md)(string $tokenName) : void
    - protected [getPageId](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/getPageId.md)() : string

}




Properties
=============

- <span id="property-inst"><b>inst</b></span>

    This property holds its own instance.
    
    

- <span id="property-sessionName"><b>sessionName</b></span>

    This property holds the sessionName for this instance.
    
    It's like a namespace containing all tokens generated by this class.
    
    You shouldn't change this, as it's unlikely that you would have a session variable named csrf_tools_token.
    But if you were, you could extend this class and change that sessionName.
    
    

- <span id="property-usePage"><b>usePage</b></span>

    This property holds the usePage for this instance.
    See the [page security conception notes](https://github.com/lingtalfi/CSRFTools/blob/master/doc/pages/page-security-conception-notes.md) for more details.
    
    



Methods
==============

- [CSRFProtector::inst](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/inst.md) &ndash; Gets the singleton instance for this class.
- [CSRFProtector::__construct](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/__construct.md) &ndash; Builds the CSRFProtector instance.
- [CSRFProtector::setUsePage](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/setUsePage.md) &ndash; Sets the usePage.
- [CSRFProtector::createToken](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/createToken.md) &ndash; Creates the token named $tokenName, stores its value in the "new" slot, and returns the token value.
- [CSRFProtector::hasToken](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/hasToken.md) &ndash; Returns whether the token identified by the given tokenName is already stored in the session.
- [CSRFProtector::isValid](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/isValid.md) &ndash; Returns whether the given $tokenName exists and has the given $tokenValue.
- [CSRFProtector::deleteToken](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/deleteToken.md) &ndash; Deletes the given $tokenName.
- [CSRFProtector::deletePageUnusedTokens](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/deletePageUnusedTokens.md) &ndash; Deletes the tokens that are not associated with the current page.
- [CSRFProtector::dump](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/dump.md) &ndash; Returns a debug string of the php session content.
- [CSRFProtector::cleanSession](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/cleanSession.md) &ndash; Cleans the session.
- [CSRFProtector::startSession](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/startSession.md) &ndash; Ensures that the php session has started.
- [CSRFProtector::addTokenForPage](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/addTokenForPage.md) &ndash; Adds a token to the pages array.
- [CSRFProtector::getPageId](https://github.com/lingtalfi/CSRFTools/blob/master/doc/api/Ling/CSRFTools/CSRFProtector/getPageId.md) &ndash; Returns the current page id.





Location
=============
Ling\CSRFTools\CSRFProtector<br>
See the source code of [Ling\CSRFTools\CSRFProtector](https://github.com/lingtalfi/CSRFTools/blob/master/CSRFProtector.php)



